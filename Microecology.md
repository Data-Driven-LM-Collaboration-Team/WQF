# 🧬 Microbiome CNN Classification Pipeline

微生物组分类任务完整流程（C组 vs O组）。  
目标：从 9000+ 菌相对丰度特征出发，通过合理特征处理 + 随机森林 分类实现有效区分。

--- 

# 项目待办事项（To-Do List）

## 一、菌群模块差异分析
- [ ] 比较三个菌群模块在正常组与肥胖组之间的差异  
  - [ ] 计算每个模块在两组的平均丰度或平均 rCLR 值  
  - [ ] 判断模块是上升还是下降趋势  
  - [ ] 使用合适的统计检验（如 Wilcoxon 秩和检验）验证显著性  

## 二、机器学习预测分析
- [ ] 使用机器学习模型预测干预后 T1 和 T2 期肥胖率  
  - [ ] 分别在安慰剂组与 Li05 组中进行预测  
  - [ ] 选择合适的特征集（菌群丰度或模块特征）  
  - [ ] 评估模型性能（AUC、Accuracy、Recall 等）  

## 三、菌丰度与临床指标相关性分析
- [ ] 在临床数据中计算菌丰度与指标的相关性  
  - [ ] 使用 85 个菌的丰度矩阵  
  - [ ] 使用筛选后的 32 个菌的丰度矩阵  
  - [ ] 计算与 BMI、体脂量、体脂率的 Spearman 或 Pearson 相关系数  
  - [ ] 可视化显著相关的菌与指标（热图或相关网络图）  

## 四、菌群动态变化分析
- [ ] 分析三个菌群模块在 T0、T1、T2 期的变化趋势  
  - [ ] 分别计算每个时间点两组的平均丰度或平均 rCLR 值  
  - [ ] 绘制折线图或箱线图展示时间变化趋势  
  - [ ] 进行时间序列显著性比较（如重复测量 ANOVA）  

## 五、参考 Cell 论文补充完善流程
- [ ] 对照参考论文正文与补充材料，完善分析流程  
  - [ ] 对应可以实现的统计与可视化部分进行补充  
  - [ ] 统一图表格式、数据标准化方法和统计呈现方式  

## 六、图表美化与标准化
- [ ] 调整所有图表的视觉风格  
  - [ ] 字体统一为 Arial 加粗  
  - [ ] 线条适中，不要过细  
  - [ ] 控制小图间边缘空隙，布局紧凑  
  - [ ] 参考 Cell 论文的图表格式进行排版  

## 七、论文撰写
- [ ] 撰写 Methods 部分  
  - [ ] 描述菌群模块划分方法与统计分析流程  
  - [ ] 说明机器学习预测模型的构建与验证方法  
- [ ] 撰写 Results 部分  
  - [ ] 展示菌群模块差异、预测结果与相关性分析  
  - [ ] 配合对应图表与统计结果说明主要结论  


## ✅ ToDo List

### 🧹 Step 1. 数据预处理

- [ ] **加载原始数据**
  - 文件：`o.csv`, `c.csv`
  - 格式：第一行样本名，第一列特征名（菌种）
- [ ] **合并并打上标签**
  - `label = 0` for O 组  
  - `label = 1` for C 组

---

### 🧾 Step 2. 过滤低丰度与低频率菌

- [ ] **过滤低丰度菌**
  ```python
  low_abundance = (df < 0.001).sum(axis=1) / df.shape[1] > 0.9
  df = df.loc[~low_abundance]


# 稳定相关菌群组分析

本研究参考 **Cell** 期刊的分析思路：  
研究者首先筛选出 **477** 个在 **W 组** 中占优势的 HQMAGs（即在三个时间点均能在 **75% 以上样本** 中检测到，且其总丰度占全部 **1,845** 个 HQMAGs 的约 **60%**）。

---

## 分析流程

### Step 1. 合并表格
- 共计 **9 个表格**
- 仅保留 **共有菌种**
- **共有物种总数：9,839**

---

### Step 2. 按样本出现频率筛选
筛选在 **75% 以上样本中出现** 的物种，并计算其 **总丰度**。

> **说明：**  
> - 筛选后进行归一化处理（`sum(normalized_abundance) = 1`）  
> - 再乘以 **10⁶** 以保持与原丰度的可比性

---

### Step 3. 分组计算相关性
使用 **FastSpar**（1,000 次置换，显著性阈值 `p ≤ 0.001`）：
- 控制组（**C 组**）
- 对照组（**O 组**）

---

##  按 95% 样本流行率 + 平均丰度 ≥ 0.001 筛选结果

| 项目 | 数值 |
|:------|:------:|
| 保留物种数量 | **127 (1.28%)** |
| 总丰度占比 | **0.7442** |

### C 组
- 显著相关边：**5,506**  
- 筛选条件：`p ≤ 0.001` 且 `correlation ≠ 0`  
- 节点数量：**126 / 126**

### O 组
- 显著相关边：**5,054**  
- 筛选条件：`p ≤ 0.001` 且 `correlation ≠ 0`  
- 节点数量：**126 / 126**

#### 稳定边分析

| 指标 | 数值 |
|:------|:------:|
| 稳定边数量（方向相同） | **4,672** |
| 稳定边占共同边比例 | **100.00%** |
| 涉及节点数 | **126** |
| 正相关边 | **46.32%** |
| 负相关边 | **53.68%** |

#### 不同阈值下网络结构变化

| 相关性阈值 | 保留边数量 | 保留比例 | 连通分量数量 |
|:-------------:|:-------------:|:-------------:|:-------------:|
| ≥0.2 | 3,976 | 85.10% | 1 |
| ≥0.3 | 2,438 | 52.18% | 1 |
| ≥0.4 | 1,333 | 28.53% | 2 |
| ≥0.5 | 634 | 13.73% | 6 |

---

##  按 75% 流行率（不推荐）

| 项目 | 数值 |
|:------|:------:|
| 保留物种数量 | **3,622 (36.81%)** |
| 总丰度占比 | **0.9875** |

### C 组
- 显著相关边：**2,781,379**
- 节点数量：**3,622 / 3,622**

### O 组
- 显著相关边：**2,375,894**
- 节点数量：**3,622 / 3,622**

#### 稳定边分析

| 指标 | 数值 |
|:------|:------:|
| 稳定边数量（方向相同） | **1,885,402** |
| 稳定边占共同边比例 | **99.99%** |
| 涉及节点数 | **3,621** |

---

## 按 95% 流行率 + 平均丰度 ≥ 0.0001 筛选结果

| 项目 | 数值 |
|:------|:------:|
| 保留物种数量 | **704 (7.16%)** |
| 总丰度占比 | **0.9034** |

### C 组
- 显著相关边：**138,385**
- 节点数量：**704 / 704**

### O 组
- 显著相关边：**129,089**
- 节点数量：**704 / 704**

#### 稳定边分析

| 指标 | 数值 |
|:------|:------:|
| 稳定边数量（方向相同） | **109,864** |
| 稳定边占共同边比例 | **99.99%** |
| 涉及节点数 | **704** |

---

### 条件：`p ≤ 0.001` 且 `|correlation| ≥ 0.5`

| 组别 | 显著相关边 | 节点数量 |
|:------|:------:|:------:|
| C 组 | 11,341 | 654 / 704 |
| O 组 | 11,375 | 662 / 704 |

#### 稳定边分析

| 指标 | 数值 |
|:------|:------:|
| 稳定边数量（方向相同） | **9,244** |
| 稳定边占共同边比例 | **100.00%** |
| 涉及节点数 | **647** |
| 正相关边 | **90.42%** |
| 负相关边 | **9.58%** |

---

### 条件：`p ≤ 0.001` 且 `correlation ≥ 0.7`（无负相关边）

| 组别 | 显著相关边 | 节点数量 |
|:------|:------:|:------:|
| C 组 | 2,677 | 527 / 704 |
| O 组 | 2,694 | 541 / 704 |

#### 稳定边分析

| 指标 | 数值 |
|:------|:------:|
| 稳定边数量（方向相同） | **2,216** |
| 稳定边占共同边比例 | **100.00%** |
| 涉及节点数 | **512** |
| 正相关边 | **100.00%** |
| 负相关边 | **0.00%** |

---

## 不同筛选比例对比

| 出现频率阈值 | 保留物种数量 | 占全部比例 | 总丰度占比 |
|:-------------:|:-------------:|:-------------:|:-------------:|
| ≥75% | 3,622 | 36.81% | 0.9875 |
| ≥80% | 3,364 | 34.19% | 0.9837 |
| ≥85% | 3,047 | 30.97% | 0.9780 |

---

---
